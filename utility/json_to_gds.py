#!/usr/bin/env python3

import json
import os
import sys
import logging
import re

error_context = ""

def get_set_count(card_data : dict) -> int:
    res = 0
    if 'wwsets' in card_data:
        res += len(card_data['wwsets'])
    if 'jpsets' in card_data:
        res += len(card_data['jpsets'])
    if res == 0:
        res = 1
    return res

def get_register_cards_gds_code(booster_data : dict) -> str:
    res = '# Content autogenerated. Data from digimoncardgame.fandom.com\n\n'
    res += 'static func register_cards():\n'
    res += '\n	CardDB.register_booster("{0}", "{1}")\n'.format(booster_data['shortname'], booster_data['name'])

    for card_data in booster_data['cards']:
        class_name = card_data['id'].replace('-', '_')
        res += '	CardDB.add_card({0}.new())\n'.format(class_name)
        
        set_count = get_set_count(card_data)
        alt_index = 2
        while alt_index <= set_count:
            alt_letter = chr(ord('@') + alt_index)
            alt_class_name = class_name + '_' + alt_letter
            res += '	CardDB.add_card({0}.new())\n'.format(alt_class_name)
            alt_index += 1
    res += '\n'
    return res


def get_color_str(color : str) -> str:
    res = '""'
    color = color[0].lower() # TO DO list
    if color == 'red':
        res = 'ColorGroup.RED'
    elif color == 'blue':
        res = 'ColorGroup.BLUE'
    elif color == 'yellow':
        res = 'ColorGroup.YELLOW'
    elif color == 'green':
        res = 'ColorGroup.GREEN'
    elif color == 'white':
        res = 'ColorGroup.WHITE'
    elif color == 'purple':
        res = 'ColorGroup.PURPLE'
    elif color == 'black':
        res = 'ColorGroup.BLACK'
    return res


def get_rarity_str(card_data : dict) -> str:
    res = '""'
    rarity = card_data['rarity']
    if rarity == 'Common':
        res = 'Rarity.C'
    elif rarity == 'Uncommon':
        res = 'Rarity.U'
    elif rarity == 'Rare':
        res = 'Rarity.R'
    elif rarity == 'Super Rare':
        res = 'Rarity.SR'
    elif rarity == 'Promo':
        res = 'Rarity.P'
    elif rarity == 'Secret Rare':
        res = 'Rarity.SEC'
    return res


def get_attribute_str(card_data : dict) -> str:
    res = '""'
    if not 'attribute' in card_data:
        return res
    attribute = card_data['attribute']
    if attribute == 'Data':
        res = 'Attribute.DATA'
    elif attribute == 'Vaccine':
        res = 'Attribute.VACCINE'
    elif attribute == 'Virus':
        res = 'Attribute.VIRUS'
    elif attribute == 'Unknown':
        res = 'Attribute.UNKNOWN'
    elif attribute == 'Free':
        res = 'Attribute.FREE'
    elif attribute == 'Variable':
        res = 'Attribute.VARIABLE'
    return res


def get_stage_level_str(card_data : dict) -> str:
    res = '""'
    stage = card_data['level']
    if card_data['form'] == 'Hybrid':
        res = 'Stage.HYBRID'
    elif stage == '2':
        res = 'Stage.IN_TRAINING'
    elif stage == '3':
        res = 'Stage.ROOKIE'
    elif stage == '4':
        res = 'Stage.CHAMPION'
    elif stage == '5':
        res = 'Stage.ULTIMATE'
    elif stage == '6':
        res = 'Stage.MEGA'
    elif stage == '7':
        res = 'Stage.MEGA'
    else:
        print(card_data['id'], "Card without stage detected!")
    return res


def get_card_type_str(card_data : dict) -> str:
    res = 'Type.DIGIMON'
    card_type = card_data['cardtype']
    if card_type == 'Tamer':
        res = 'Type.TAMER'
    elif card_type == 'Option':
        res = 'Type.OPTION'
    elif card_type == 'Digi-Egg':
        res = 'Type.DIGITAMA'
    return res


def norm_eff(effect_text):
    return effect_text.replace('"', '\\"').replace("\n", "\\n")


def get_card_gds_code(card_data : dict) -> str:
    global error_context
    error_context = card_data['id']

    is_tama = bool(card_data['cardtype'] == 'Digi-Egg')
    is_digimon = bool(card_data['cardtype'] == 'Digimon')
    is_tamer = bool(card_data['cardtype'] == 'Tamer')
    is_option = bool(card_data['cardtype'] == 'Option')

    template = ''
    template += 'class {0} extends Card:\n'
    template += '	func _init():\n'

    template += '		name = "{0}"\n'.format(card_data['name'])
    template += '		type = {0}\n'.format(get_card_type_str(card_data))
    template += '		color = {0}\n'.format(get_color_str(card_data['color']))
    template += '		rarity = {0}\n'.format(get_rarity_str(card_data))
    template += '		id = "{1}"\n'

    if not is_tama:
        template += '		play_cost = {0}\n'.format(card_data['playcost'])
        
    if is_digimon or is_tama:
        if 'level' in card_data and not card_data['level'] == "-":
            template += '		level = {0}\n'.format(card_data['level'])
            template += '		stage_level = {0}\n'.format(get_stage_level_str(card_data))
        else:
            template += '		level = 0\n'
            template += '		stage_level = ""\n'
    if is_digimon:
        template += '		attribute = {0}\n'.format(get_attribute_str(card_data))
    if is_digimon and 'evocost' in card_data:
        template += '		digivolve_color = {0}\n'.format(get_color_str(card_data['evocolor1']))
        template += '		digivolve_cost = {0}\n'.format(card_data['evocost'])
        template += '		digivolve_level = {0}\n'.format(card_data['evolevel1'])
    if is_digimon and 'evocost2' in card_data and card_data['evocost2'] != '-':
        template += '		digivolve_color_2 = {0}\n'.format(get_color_str(card_data['evocolor2']))
        template += '		digivolve_cost_2 = {0}\n'.format(card_data['evocost2'])
        template += '		digivolve_level_2 = {0}\n'.format(card_data['evolevel2'])
    if is_digimon or is_tama:
        template += '		digimon_type = "{0}"\n'.format(card_data['type'])
    if is_digimon:
        template += '		power = {0}\n'.format(card_data['dp'])
    if 'effect1' in card_data:
        template += '		effect_text = "{0}"\n'.format(norm_eff(card_data['effect1']))
    if 'effect2' in card_data:
        if is_digimon or is_tama:
            template += '		inherited_effect_text = "{0}"\n'.format(norm_eff(card_data['effect2']))
        else:
            template += '		sec_effect_text = "{0}"\n'.format(norm_eff(card_data['effect2']))
    
    if 'ruling' in card_data:
        ruling_str = '		ruling = [\n'
        for r in card_data['ruling']:
            ruling_str += '					"' + norm_eff(r[0]) + '",\n'
            ruling_str += '					"' + norm_eff(r[1]) + '",\n'
        ruling_str += ']\n'
        ruling_str = ruling_str
        template += ruling_str
    
    card_id = card_data['id'] # BT1-005
    class_name = card_id.replace('-', '_') # BT1_005
    res = template.format(class_name, card_id)
    if 'tsname' in card_data:
            res += '		notes = "{0}"\n'.format(card_data['tsname'])
    res += '\n'

    set_count = get_set_count(card_data)
    alt_index = 2
    while alt_index <= set_count:
        alt_letter = chr(ord('@') + alt_index)
        alt_id = card_id + ' (' + alt_letter + ')' # BT1-005 (B)
        alt_class_name = class_name + '_' + alt_letter # BT1_005_B
        res += template.format(alt_class_name, alt_id)
        res += '		is_parallel = true\n'
        res += '		notes = "parallel promo'
        if 'tsname' in card_data:
            res += ' ' + card_data['tsname'] + '"'
        else:
            res += '"'
        res += '\n\n'
        alt_index += 1
    
    return res


def dict_to_gds(data : dict) -> str:
    res = ''
    res += get_register_cards_gds_code(data)
    for card_data in data['cards']:
        res += get_card_gds_code(card_data)
    return res


def main():
    if len(sys.argv) < 2:
        print("Error: you have to provide one or more files as argument.")
        sys.exit(1)
    
    if sys.argv[1] == "--all":
        files = [f for f in os.listdir('.') if os.path.isfile(f) and f.endswith('.json')]
    else:
        files = sys.argv[1:]

    for filename in files:
        try:
            with open(filename, 'r') as f:
                data = json.load(f)
                gds_code = dict_to_gds(data)
                # TODO error handling
                file = open(data['shortname'] + ".gd", "w")
                file.write(gds_code) 
                file.close() 
        except Exception as e:
            logging.exception("File " + filename + " could not be open: " + error_context)
            sys.exit(1)


if __name__ == "__main__":
    main()
